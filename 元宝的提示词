# baidu_spider.py 精准搜索实现
import requests
from bs4 import BeautifulSoup
import time
import random
from urllib.parse import quote

class BaiduSpider:
    def __init__(self):
        self.session = requests.Session()
        self.headers = {
            'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/91.0.4472.124 Safari/537.36',
            'Accept': 'text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8',
            'Accept-Language': 'zh-CN,zh;q=0.9,en;q=0.8',
            'Accept-Encoding': 'gzip, deflate, br',
            'DNT': '1',
            'Connection': 'keep-alive',
            'Upgrade-Insecure-Requests': '1',
        }
        self.session.headers.update(self.headers)

    def search(self, keyword, page=1):
        """精准百度搜索"""
        try:
            # 编码关键词，确保中文正确传输
            encoded_keyword = quote(keyword)
            url = f"https://www.baidu.com/s?wd={encoded_keyword}&pn={(page-1)*10}"
            
            # 添加随机延迟避免封禁
            time.sleep(random.uniform(1, 3))
            
            response = self.session.get(url, timeout=10)
            response.raise_for_status()
            
            # 使用更精准的HTML解析
            return self.parse_search_results(response.text, keyword)
            
        except Exception as e:
            print(f"搜索失败: {str(e)}")
            return []

    def parse_search_results(self, html, original_keyword):
        """精准解析百度搜索结果"""
        soup = BeautifulSoup(html, 'html.parser')
        results = []
        
        # 定位主要搜索结果容器
        search_results = soup.find_all('div', class_='result')
        if not search_results:
            search_results = soup.find_all('div', class_='c-container')
        
        for result in search_results:
            try:
                # 提取标题
                title_elem = result.find('h3') or result.find('a')
                if not title_elem:
                    continue
                    
                title = title_elem.get_text().strip()
                
                # 验证标题相关性（必须包含关键词）
                if original_keyword not in title:
                    continue
                
                # 提取链接
                link = title_elem.get('href')
                if link and link.startswith('/'):
                    link = 'https://www.baidu.com' + link
                
                # 提取摘要
                abstract_elem = result.find('div', class_='c-abstract') or result.find('div', class_='content-right_8Zs40')
                abstract = abstract_elem.get_text().strip() if abstract_elem else ""
                
                if title and link:
                    results.append({
                        'title': title,
                        'url': link,
                        'abstract': abstract,
                        'source': 'baidu',
                        'timestamp': time.time()
                    })
                    
            except Exception as e:
                print(f"解析单个结果失败: {str(e)}")
                continue
                
        return results[:10]  # 限制返回数量